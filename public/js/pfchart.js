var helpers={zeroToMax:function(a){return[0,helpers.max(a)]},zeroToLayeredMax:function(a){a=a[a.length-1];if(!_.isArray(a))throw Error("Expected array, but found ["+typeof a+"]: "+a);return[0,d3.max(a,function(a){return a.value0+a.value})]},minToZero:function(a){return[helpers.min(a),0]},minToMax:function(a){return[helpers.min(a),helpers.max(a)]},minToMaxDates:function(a){var b=new Date(a[0].label);a=new Date(a[a.length-1].label);a=moment(a).add("months",1).toDate();b=moment(b).subtract("months",
1).toDate();return[b,a]},min:function(a){if(a&&a.length)switch(a.length){case 0:return null;case 1:return 0;default:var b=helpers._cloneAndSort(a,helpers.sortByValueAsc);a=_.first(b).value;return 0<a?(b=helpers._findSecondUniqueValue(b)-a,Math.max(0,a-b)):a}else return null},max:function(a){if(a&&a.length)switch(a.length){case 0:return null;case 1:return 2*a[0].value;default:var b=helpers._cloneAndSort(a,helpers.sortByValueAsc);a=_.last(b).value;b=helpers._findSecondToLastUniqueValue(b);return a+
(a-b)}else return null},sortAsc:function(a,b){return a-b},sortDesc:function(a,b){return b-a},sortByLabelAsc:function(a,b){return d3.ascending(a.label,b.label)},sortByLabelDesc:function(a,b){return d3.descending(a.label,b.label)},sortByValueAsc:function(a,b){return helpers.sortAsc(a.value,b.value)},sortByValueDesc:function(a,b){return helpers.sortDesc(a.value,b.value)},sortByDateAsc:function(a,b){return a>b?1:a<b?-1:0},sortByDateDesc:function(a,b){return-1*helpers.sortByDateAsc(a,b)},containsPoint:function(a,
b){var c=b.x>=a.x&&b.x<=a.x+a.w;c&&(c=b.y>=a.y&&b.y<=a.y+a.h);return c},getCssPropertyValue:function(a,b){var c=$(a).hide().appendTo("body"),d=c.css(b);c.remove();return d},scaleValue:function(a,b,c,d){return 0===c?0:d(c)},isEmpty:function(a){return"undefined"===typeof a||null==a},getRandomNumber:function(a){return Math.floor(Math.random()*a)+1},indexOfProperty:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][c]===b[c])return d;return-1},getMonthsElapsed:function(a,b){var c=moment(a),d=helpers.isEmpty(b)?
moment():moment(b);return Math.abs(c.diff(d,"month"))},_getDate:function(a){return new Date(a.label)},_cloneAndSort:function(a,b){var c=a.slice(0);c.sort(b);return c},_findSecondToLastUniqueValue:function(a,b){switch(a.length){case 0:return null;case 1:case 2:return a[0].value;default:return helpers.isEmpty(b)&&(b=a.length-2),0===b||a[b].value!==_.last(a).value?a[b].value:helpers._findSecondToLastUniqueValue(a,b-1)}},_findSecondUniqueValue:function(a,b){switch(a.length){case 0:return null;case 1:return a[0].value;
case 2:return a[1].value;default:return helpers.isEmpty(b)&&(b=1),b===a.length-1||a[b].value!==_.first(a).value?a[b].value:helpers._findSecondUniqueValue(a,b+1)}}};var D3Helpers={appendG:function(a,b,c,d){return a.attr("width",b+d.left+d.right).attr("height",c+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")")},translateOffset:function(a,b){var c=_.isArray(a)?a:d3.select(a),d=D3Helpers.getTranslation(c);c.attr("transform","translate("+(d.x+b.x)+", "+(d.y+b.y)+")")},getTranslation:function(a){var b={x:0,y:0};if(a=a.attr("transform"))if(a=a.match(/\((-?[0-9]+),(-?[0-9]+)\)/))b.x=+a[1],b.y=+a[2];return b},buildD3Arr:function(a){var b=
[];_.each(a,function(a){b=b.concat(d3.selectAll(a)[0])});return b},checkSelection:function(a,b){var c=a.selectAll(b);if(0===c[0].length)throw Error("No elements found for selector ["+b+"].");return c}};var DebugHelpers={DEFAULT_COLOR:"green",drawSvgVerticalLine:function(a){var b=$(document).height();d3.select("svg").append("path").attr("d","M"+a+",0 L"+a+","+b).attr("stroke",DebugHelpers.DEFAULT_COLOR);d3.select("svg").append("text").attr("x",a+5).attr("y",b/2).text("x: "+a)},drawSvgHorizontalLine:function(a){var b=$(document).width();d3.select("svg").append("path").attr("d","M0,"+a+" L"+b+","+a).attr("stroke",DebugHelpers.DEFAULT_COLOR);d3.select("svg").append("text").attr("x",b/2).attr("y",a+
15).text("y: "+a)},drawSvgCircle:function(a,b){d3.select("svg").append("circle").attr("r",3).attr("cx",a).attr("cy",b).style("fill",DebugHelpers.DEFAULT_COLOR).style("stroke","black");d3.select("svg").append("text").attr("x",a+15).attr("y",b+3).text(a+", "+b)},drawDomBox:function(a,b){$("<div style='position: absolute; left: "+a+"px; top: "+b+"px; border: 1px solid "+DebugHelpers.DEFAULT_COLOR+"; color: "+DebugHelpers.DEFAULT_COLOR+"; font: 16px normal Arial'>"+a+", "+b+"</div>").appendTo($("body"))}};var barChartHelpers={MIN_BAR_WIDTH_FOR_LABEL:30,drawBars:function(a,b,c,d){a._range&&b.attr("class",function(b){return a._range.cssClassNameFn(b)});var e=0<=a.constructor.name.toLowerCase().indexOf("stacked");b.attr("x",function(b){return e?helpers.scaleValue(a,"x",b.value0,a._xScale):0}).attr("y",function(b){return a._yScale(b.label)}).attr("width",0).transition().duration(constants.TRANSITION_DURATION).attr("width",function(b){return helpers.scaleValue(a,"x",b.value,a._xScale)}).attr("height",c-
d)},addBarLabels:function(a,b,c){a.svgElem.selectAll(".bar-label").remove();a.svgElem.selectAll(".bar-label").data(b).enter().append("text").attr("class","bar-label").transition().delay(constants.TRANSITION_DURATION).attr("x",function(b){return a._xScale(b.value)}).attr("y",function(b){return a._yScale(a._tickLabelFn(b))}).attr("dx",-5).attr("dy",(c+5)/2).text(function(b){var c=helpers.scaleValue(a,"x",b.value,a._xScale);return barChartHelpers._getLabelDisplay(c,b.value)})},_getLabelDisplay:function(a,
b){return _.str.isBlank(b)?(console.log("No labelTxt for barWidth ["+a+"]."),""):(new String(b)).length+a>=barChartHelpers.MIN_BAR_WIDTH_FOR_LABEL?b.toLocaleString():""}};var constants={TRANSITION_DURATION:1E3,ORIENTATION:{top:"top",bottom:"bottom",left:"left",right:"right"},DEFAULT_MARGINS:{top:35,bottom:10,left:75,right:10},DEFAULT_TICK_LABEL_FN:function(a){return a.label},CIRCLE_CLS_NAME:"dot",DESELECTED_COLOR:"#aaa",AXIS_ID:{x:"x-axis",y:"y-axis"},AXIS_TITLE_ID:{x:"x-axis-title",y:"y-axis-title"},Format:function(a,b,c){this.id=a;this.specifier=b;this.d3Format=c?c:d3.format;this.specifier&&this.resetFormatFn()}};constants.Format.prototype.format=function(a){return this.formatFn(a)};
constants.Format.prototype.setSpecifier=function(a){this.specifier=a;this.resetFormatFn();return this};constants.Format.prototype.getFormatFn=function(){return this.formatFn};constants.Format.prototype.setFormatFn=function(a){this.formatFn=a;return this};constants.Format.prototype.resetFormatFn=function(){this.formatFn=this.d3Format(this.specifier)};
constants.FORMAT_FACTORY=function(a){switch(a){case "date":return new constants.Format(a,"%d%Y",d3.time.format);case "large-number":return new constants.Format(a,"s");case "number":return new constants.Format(a,",.0f");case "percentage":return new constants.Format(a,"1%");default:return new constants.Format(a)}};function Chart(){}
Chart.prototype.config=function(a){var b=this.__proto__.constructor.name;this.idPrefix(b+"-");var c=defaults[b];if(!c)throw Error("No defaults defined for chart type ["+b+"] in defaults.js.");for(var d in a)c[d]=a[d];for(d in c)if("function"===typeof this[d])switch(a=c[d],typeof a){case "undefined":throw Error("No value for key ["+d+"].");default:this[d](a)}else if("container"!==d&&"svgElem"!==d)throw Error("Unknown key ["+d+"].");c.container||(c.container="#svg-container");this._margins||this.margins(constants.DEFAULT_MARGINS);
this._tickLabelFn||this.tickLabelFn(constants.DEFAULT_TICK_LABEL_FN);helpers.isEmpty(this._drawImmediately)&&this.drawImmediately(!0);this.axisGradient({});if(c.svgElem)this.svgElem=c.svgElem,d=this.svgElem[0][0].parentNode;else if(c.container){d=d3.select(c.container);if(helpers.isEmpty(d[0][0]))throw Error("Cannot add chart because no element for selector ["+c.container+"].");d.datum(this._data);this.svgElem=this.createSvgElem(d)}else throw Error("Chart requires either an 'svgElem' property (a pre-existing SVG element) or 'container' property (a DOM element where we should append a new SVG element).");
this.chart(d);this.drawImmediately()&&(this.addAxes(),this.draw(),this.enableToolTips());this._addBrushes()};Chart.prototype.setDefaultXDomainAndScale=function(){return _.isFunction(this._xDomain)?(this.xDomain(this._xDomain(this._data)),this._xScale&&this._xScale.domain(this._xDomain),!0):!1};Chart.prototype.setDefaultYDomainAndScale=function(){return _.isFunction(this._yDomain)?(this.yDomain(this._yDomain(this._data)),this._yScale&&this._yScale.domain(this._yDomain),!0):!1};
Chart.prototype.createSvgElem=function(a){a=a.append("svg");return D3Helpers.appendG(a,this.width(),this.height(),this.margins())};Chart.prototype.getXViewport=function(){var a=this.margins();return this._width-a.left-a.right};Chart.prototype.getYViewport=function(){var a=this.margins();return this._height-a.top-a.bottom};
Chart.prototype.addAxes=function(){var a=[],b=this.axes();if(b){if(b.x&&b.x.orientation){var c=this.addAxis(this.xScale(),b.x.orientation);this.addAxisTitle(c,b.x.title,b.x.orientation);a.push(c[0][0])}b.y&&b.y.orientation&&(c=this.addAxis(this.yScale(),b.y.orientation),this.addAxisTitle(c,b.y.title,b.y.orientation),a.push(c[0][0]))}return a};
Chart.prototype.addAxis=function(a,b){var c=this.svgElem.append("g").attr("id",this.getAxisElemId(this.getAxisId(b))).attr("class","axis");return this.setAxis(c,a,b)};
Chart.prototype.setAxis=function(a,b,c){this.setOrientation(a,c);b=d3.svg.axis(a).scale(b).orient(c);c=this.getAxisId(c);this._ticks&&this._ticks[c]&&b.ticks(this._ticks[c]);var d=this.getTickFormatFn(c);d&&b.tickFormat(d);a.transition().duration(constants.TRANSITION_DURATION).call(b);if(b=this._axes[c].range)this._axisGradient[c]=new AxisGradient(this,c,b),this._axisGradient[c].draw();return a};
Chart.prototype.getDomainArr=function(a){a="x"===a?this.xDomain():this.yDomain();return _.isFunction(a)?a(this._data):_.isArray(a)?a:null};Chart.prototype.isDomainAscending=function(a){if(a=this.getDomainArr(a))return a[0]<a[1];throw Error("No domain on chart.");};Chart.prototype.rotateLabels=function(a,b,c,d){d3.select("#"+this.idPrefix()+constants.AXIS_ID[a]).selectAll("g text").attr("transform","rotate("+b+")").attr("dx",c).attr("dy",d)};
Chart.prototype.getTickFormatFn=function(a){return this._tickFormat&&(a=this._tickFormat[a])?a.fn?a.fn:a.getFormatFn():null};Chart.prototype.enableToolTips=function(){if(this._toolTipFn){var a=this;$("."+constants.CIRCLE_CLS_NAME).tipsy({gravity:"w",html:!0,title:function(){return a._toolTipFn(this.__data__)}})}};
Chart.prototype.setOrientation=function(a,b){switch(b){case constants.ORIENTATION.bottom:a.attr("transform","translate(0,"+this.getYViewport()+")");break;case constants.ORIENTATION.right:a.attr("transform","translate("+this.getXViewport()+",0)");break;default:a.attr("transform",null)}};Chart.prototype.addAxisTitle=function(a,b,c){var d=a.append("text").attr("id",this._idPrefix+constants.AXIS_TITLE_ID[this.getAxisId(c)]).attr("class","axis-title");return this.setAxisTitle(d,a,b,c)};
Chart.prototype.setAxisTitle=function(a,b,c,d){if(!_.str.isBlank(c)){b=this.getXViewport()/2;var e=this.getYViewport()/2;switch(d){case constants.ORIENTATION.top:a.attr("transform",null).attr("x",b).attr("y",-35);break;case constants.ORIENTATION.bottom:a.attr("transform",null).attr("x",b).attr("y",-this.margins().bottom+50);break;case constants.ORIENTATION.left:a.attr("transform","rotate(-90)").attr("x",-e).attr("y",-this.margins().left+10);break;case constants.ORIENTATION.right:a.attr("transform",
"rotate(90)").attr("x",e).attr("y",-50)}a.style("text-anchor","middle").text(c)}return a};Chart.prototype.getAxisId=function(a){switch(a){case constants.ORIENTATION.top:case constants.ORIENTATION.bottom:return"x";default:return"y"}};Chart.prototype._addBrushes=function(){if(this._brushes){this._brushes.selectionListener&&$(document).select(this._brushes.selectionListener);var a=this;_.each(["x","y"],function(b){a._addBrush(b)})}};
Chart.prototype._addBrush=function(a){var b=this._brushes[a];if(b){a=new Brush(this,a);var c=b.brushPosition;c&&(c.position&&(a.brushPosition.position=c.position),c.percentage&&(a.brushPosition.percentage=c.percentage));b.range&&(a.range=b.range);a.draw(this.drawImmediately())}};Chart.prototype.getAxisElemId=function(a){return this._idPrefix+constants.AXIS_ID[a]};Chart.prototype.getAxisElem=function(a){return d3.select("#"+this.getAxisElemId(a))};
Chart.prototype.getAxisGradient=function(a){if(this._axisGradient)return this._axisGradient[a];throw Error("No AxisGradients defined for chart.");};Chart.prototype.axisGradient=function(a){if(!arguments.length)return this._axisGradient;this._axisGradient=a;return this};Chart.prototype.idPrefix=function(a){if(!arguments.length)return this._idPrefix;this._idPrefix=a;return this};Chart.prototype.drawImmediately=function(a){if(!arguments.length)return this._drawImmediately;this._drawImmediately=a;return this};
Chart.prototype.axes=function(a){if(!arguments.length)return this._axes;this._axes=a;return this};Chart.prototype.brushes=function(a){if(!arguments.length)return this._brushes;this._brushes=a;return this};Chart.prototype.width=function(a){if(!arguments.length)return this._width;this._width=a;return this};Chart.prototype.height=function(a){if(!arguments.length)return this._height;this._height=a;return this};
Chart.prototype.xScale=function(a){if(!arguments.length)return this._xScale;this._xScale=a;return this};Chart.prototype.yScale=function(a){if(!arguments.length)return this._yScale;this._yScale=a;return this};Chart.prototype.ticks=function(a){if(!arguments.length)return this._ticks;this._ticks=a;return this};Chart.prototype.tickFormat=function(a){if(!arguments.length)return this._tickFormat;this._tickFormat=a;return this};
Chart.prototype.xDomain=function(a){if(!arguments.length)return this._xDomain;this._xDomain=a;return this};Chart.prototype.yDomain=function(a){if(!arguments.length)return this._yDomain;this._yDomain=a;return this};Chart.prototype.dateFormat=function(a){if(!arguments.length)return this._dateFormat;this._dateFormat=a;return this};Chart.prototype.margins=function(a){if(!arguments.length)return this._margins;this._margins=a;return this};
Chart.prototype.brushManager=function(){this._brushManager||(this._brushManager=new BrushManager);return this._brushManager};Chart.prototype.addBrush=function(a){this.brushManager().register(a);return this};Chart.prototype.tickLabelFn=function(a){if(!arguments.length)return this._tickLabelFn;this._tickLabelFn=a;return this};Chart.prototype.cssClassNameFn=function(a){if(!arguments.length)return this._cssClassNameFn;this._cssClassNameFn=a;return this};
Chart.prototype.labelFn=function(a){if(!arguments.length)return this._labelFn;this._labelFn=a;return this};Chart.prototype.toolTipFn=function(a){if(!arguments.length)return this._toolTipFn;this._toolTipFn=a;return this};Chart.prototype.range=function(a){if(!arguments.length)return this._range;this._range=a;return this};Chart.prototype.stack=function(a){if(!arguments.length)return this._stack;this._stack=a;return this};
Chart.prototype.sortBy=function(a){if(!arguments.length)return this._sortBy;this._sortBy=a;return this};Chart.prototype.data=function(a){if(!arguments.length)return this._data;this._data=a;return this};function PairedColumnChart(a){this.config(a)}_.extend(PairedColumnChart.prototype,Chart.prototype);PairedColumnChart.prototype.chart=function(a){this.setDefaultXDomainAndScale();this.xDomain(d3.range(this._data.length));this._xScale.domain(this._xDomain).rangeRoundBands([0,this.getXViewport()],pairedChartHelpers.INNER_PADDING,pairedChartHelpers.OUTER_PADDING);this.setDefaultYDomainAndScale();this._yScale.range([this.getYViewport(),0])};
PairedColumnChart.prototype.draw=function(){var a=this,b=this.svgElem.selectAll(".pair").data(this.data()).enter().append("g").attr("class","pair").attr("transform",function(b,d){return"translate("+a._xScale(d)+",0)"});this.addColumn(b,0);this.addColumn(b,1);this.addColumnLabel(b,0);this.addColumnLabel(b,1)};
PairedColumnChart.prototype.addColumn=function(a,b){var c=this,d=0==b?"value0":"value";a.append("rect").attr("class",function(a,d){return c._getClassName(a,b,d)}).attr("x",0===b?c._xScale.rangeBand()/2:0).attr("width",c._xScale.rangeBand()/2).attr("y",c.getYViewport()).attr("height",0).transition().duration(constants.TRANSITION_DURATION).attr("y",function(a){return c._yScale(a[d])}).attr("height",function(a){return c.getYViewport()-c._yScale(a[d])})};
PairedColumnChart.prototype.addColumnLabel=function(a,b){var c=this,d=0==b?"value0":"value";a.append("text").attr("x",0).attr("y",function(a){return c._yScale(a[d])-15}).attr("dy",10).attr("dx",(0===b?3:1)*(c._xScale.rangeBand()/4)).transition().delay(constants.TRANSITION_DURATION).text(function(a){a=a[d];return 0==a?"":c._labelFn?c._labelFn(a):a})};PairedColumnChart.prototype._getClassName=function(a,b,c){return this._cssClassNameFn?this._cssClassNameFn(a,b,c):"pair-"+(b+1)};function BarChart(a){this.includeBarLabels=!0;this.config(a)}_.extend(BarChart.prototype,Chart.prototype);BarChart.prototype.chart=function(a){this.setDefaultXDomainAndScale();this.setDefaultYDomainAndScale();this.xScale().range([0,this.getXViewport()]);this.yScale().rangeRoundBands([this.getYViewport(),0],0)};
BarChart.prototype.draw=function(){var a=this;this.sort();this.data();this.barHeight=this._yScale.rangeBand();this.barHeight=Math.max(this.barHeight,2);this._bars=this.svgElem.selectAll("rect").data(this.data(),function(b){return a._tickLabelFn(b)});this._bars.exit().remove();this._bars.enter().insert("rect");barChartHelpers.drawBars(this,this._bars,this.barHeight,2);var b=this.axes();b&&(b.x&&b.x.orientation&&this.setAxis(this.getAxisElem("x"),this.xScale(),b.x.orientation),b.y&&b.y.orientation&&
this.setAxis(this.getAxisElem("y"),this.yScale(),b.y.orientation));this.includeBarLabels&&barChartHelpers.addBarLabels(this,this.data(),this.barHeight)};BarChart.prototype.sort=function(){var a=this;this._yScale.domain(this.data().sort(this._sortBy).map(function(b){return a._tickLabelFn(b)})).copy()};
BarChart.prototype.getLabelDisplay=function(a,b){return _.str.isBlank(b)?(console.log("No labelTxt for barWidth ["+a+"]."),""):(new String(b)).length+a>=this.MIN_BAR_WIDTH_FOR_LABEL?b.toLocaleString():""};function LineChart(a){this.clipId="line-chart-clip";this.drawDelay=50;this.drawWidth=0;this.drawWidthIncrement=50;this.intervalId=-1;this.config(a)}_.extend(LineChart.prototype,Chart.prototype);LineChart.prototype.chart=function(a){this.ticks({x:this._data.length,y:this._data.length});this.setDefaultXDomainAndScale();this._xScale.range([0,this.getXViewport()]);this.setDefaultYDomainAndScale();this._yScale.range([this.getYViewport(),0])};
LineChart.prototype.draw=function(a){var b=this;a=d3.svg.line().x(function(a){return b._xScale(a.label)}).y(function(a){return b._yScale(a.value)});this.hide();this.drawCircles();this.appendHidden(this.svgElem,"g").append("path").datum(this.data()).attr("d",a);this.intervalId=setInterval(_.bind(this.show,this),this.drawDelay)};
LineChart.prototype.show=function(){d3.select("#"+this.clipId).append("rect").attr("x",1).attr("y",1).attr("width",this.drawWidth).attr("height",this._height);this.drawWidth+=this.drawWidthIncrement;this.drawWidth>=this._width&&(clearInterval(this.intervalId),this.enableToolTips())};LineChart.prototype.hide=function(){this.svgElem.append("defs").append("clipPath").attr("id",this.clipId)};
LineChart.prototype.appendHidden=function(a,b){var c=this.svgElem.append(b);c.attr("clip-path","url(#"+this.clipId+")");return c};LineChart.prototype.drawCircles=function(){for(var a=this.data(),b=0;b<a.length;b++){var c=a[b];this.appendHidden(this.svgElem,"circle").datum(c).attr("class",constants.CIRCLE_CLS_NAME).attr("r",3.5).attr("cx",this._xScale(c.label)).attr("cy",this._yScale(c.value))}};function ScatterChart(a){this.RADIUS=3.5;this.config(a)}_.extend(ScatterChart.prototype,Chart.prototype);ScatterChart.prototype.chart=function(a){this._xScale.range([0,this.getXViewport()]);this.xDomain(this._xDomain(this._data.map(function(a){return{value:a.label}})));this._xScale.domain(this._xDomain);this._yScale.range([this.getYViewport(),0]);this.setDefaultYDomainAndScale()};ScatterChart.prototype.draw=function(){this.drawCircles()};
ScatterChart.prototype.drawCircles=function(a,b){var c=!a,d=this._data.length;if(!c){var e=a.length;if(e!==d)throw Error("UI and model are out-of-sync: ["+e+"] circles, ["+d+"] data items");}for(var f=this,g,h=0;h<d;h++)e=this._data[h],e.id="dot-"+h,g=c?this.svgElem.append("circle"):d3.select(a[h]),g.attr("id",e.id).attr("class",constants.CIRCLE_CLS_NAME).on("mouseover",function(){f._toggle(this,!0)}).on("mouseout",function(){f._toggle(this,!1)}),b?g=b(g):g.attr("opacity",0).transition().duration(constants.TRANSITION_DURATION).attr("opacity",
1),g.attr("r",this.RADIUS).attr("cx",f._xScale(e.label)).attr("cy",f._yScale(e.value));d3.selectAll("."+constants.CIRCLE_CLS_NAME).data(this._data)};ScatterChart.prototype._toggle=function(a,b){var c=d3.select(a);c.classed("highlight",b);var d=b?"select":"deselect",c=c.attr("id");$.event.trigger({type:d,id:c})};function StackedBarChart(a){this.config(a)}_.extend(StackedBarChart.prototype,Chart.prototype);
StackedBarChart.prototype.chart=function(a){stackedChartHelpers.init(this);var b=this;this.xDomain(helpers.zeroToLayeredMax);this.xDomain(this._xDomain(this._data));this._xScale.domain(this._xDomain).range([0,this.getXViewport()]);a=stackedChartHelpers.getFirstLayerArr(this);this.yDomain(a.map(function(a){return b._range?a.label:b._tickLabelFn(a)}));this._yScale.domain(this._yDomain).rangeRoundBands([this.getYViewport(),0])};
StackedBarChart.prototype.draw=function(){var a=this.svgElem.selectAll("g.band").data(this.data()).enter().append("g").attr("class",function(a,b){return"band band-"+(b+1)}).selectAll("rect").data(Object).enter().append("rect"),b=this._yScale.rangeBand();barChartHelpers.drawBars(this,a,b,0)};var defaults={};defaults.AreaChart={width:800,height:400,container:".module",xScale:d3.time.scale(),yScale:d3.scale.linear(),xDomain:helpers.minToMax,yDomain:helpers.zeroToMax,dateFormat:"%d-%b-%y"};defaults.BarChart={width:500,height:600,xScale:d3.scale.linear(),yScale:d3.scale.ordinal(),xDomain:helpers.zeroToMax,sortBy:helpers.sortByLabelDesc};defaults.StackedBarChart={xScale:d3.scale.linear(),yScale:d3.scale.ordinal()};defaults.StackedColumnChart={xScale:d3.scale.ordinal(),yScale:d3.scale.linear()};
defaults.PairedColumnChart={xScale:d3.scale.ordinal(),yScale:d3.scale.linear(),yDomain:helpers.zeroToMax};defaults.LineChart={width:800,height:400,xScale:d3.time.scale(),yScale:d3.scale.linear(),xDomain:helpers.minToMaxDates,yDomain:helpers.zeroToMax};defaults.LineLabelledChart={width:800,height:400,xScale:d3.scale.linear(),yScale:d3.scale.linear(),xDomain:helpers.minToMax,yDomain:helpers.zeroToMax};
defaults.ScatterChart={width:800,height:400,xScale:d3.scale.linear(),yScale:d3.scale.linear(),xDomain:helpers.minToMax,yDomain:helpers.minToMax};function PairedColumnBubbleChart(a,b,c){this.drawCirclesImmediately=helpers.isEmpty(c)?!0:c;var d=this;this.dataForSecondColumn=[];_.each(a.data,function(a){d.dataForSecondColumn.push([])});_.each(b,function(a){d.dataForSecondColumn[a.value-1].push(a)});defaults.PairedColumnBubbleChart=defaults.PairedColumnChart;defaults.PairedColumnBubbleChart.idPrefix="paired-bubble-column-chart-";this.RADIUS=3;this.H_PADDING=7.5;this.FAKE_CIRCLE_CLASS_NAME=this.__proto__.constructor.name+"-"+helpers.getRandomNumber(10);
this.config(a)}_.extend(PairedColumnBubbleChart.prototype,PairedColumnChart.prototype);PairedColumnBubbleChart.prototype.draw=function(){PairedColumnChart.prototype.draw.call(this);this.toggleBars(!1);this.drawCirclesImmediately&&(this.drawCircles(),this.toggleBars(!0))};
PairedColumnBubbleChart.prototype.drawCircles=function(a,b){var c=helpers.getCssPropertyValue("<circle class='circle-in-bar'/>","fill");this.barWidth=this._xScale.rangeBand()/2;for(var d=!a,e=this.RADIUS/2,f=Math.floor(this.barWidth/(this.RADIUS+this.H_PADDING)),g=this.getYViewport()-e,h=0,l,q,k,m,r,n,s,t,p=0;p<this.dataForSecondColumn.length;p++){l=this.dataForSecondColumn[p];l=l.length;q=Math.ceil(l/f);k=this._yScale(this._data[p].value0);k=this.getYViewport()-k;q=this._calculateVerticalPadding(q,
this.RADIUS,k);k=this._xScale(p)+this.barWidth+e;for(var u=r=m=0;u<l;u++)n=d?this.svgElem.append("circle"):d3.select(a[h++]),s=k+m*(this.RADIUS+this.H_PADDING)+1.25*this.RADIUS,t=g-r*(this.RADIUS+q)-e,++m,m===f&&(m=0,++r),b?n=b(n):n.attr("opacity",0).transition().duration(constants.TRANSITION_DURATION),n.attr("class",this.FAKE_CIRCLE_CLASS_NAME).attr("r",this.RADIUS).attr("cx",s).attr("cy",t).style("fill",c)}};
PairedColumnBubbleChart.prototype.onCirclesMoved=function(){var a="circle."+this.FAKE_CIRCLE_CLASS_NAME,b=d3.selectAll(a);0<b[0].length?b.style("opacity",null).attr("opacity",1):console.log("No circles for selector ["+a+"].")};PairedColumnBubbleChart.prototype.toggleBars=function(a,b){var c=this.svgElem.selectAll("g.pair");b?b(c):(a&&c.transition().duration(2*constants.TRANSITION_DURATION),c.attr("opacity",a?1:0))};
PairedColumnBubbleChart.prototype._calculateVerticalPadding=function(a,b,c){return(c-a*b)/a};function Range(a){this.valueThresholds=a.valueThresholds;var b=this.valueThresholds.length;this.valueLabels=this._checkArg(b,a.valueLabels,"valueLabels");this.cssClassNames=this._checkArg(b,a.cssClassNames,"cssClassNames");this.countToIndex={}}Range.prototype.valueLabelFn=function(a){return this.valueLabels[this.getBucketForCount(a.value)]};
Range.prototype.getIndexOf=function(a){for(var b=0;b<this.valueLabels.length;b++)if(this.valueLabels[b]===a)return b;throw Error("Range label ["+a+"] not found.");};Range.prototype.cssClassNameFn=function(a){return this.cssClassNames[this.getBucketForCount(a.value)]};Range.prototype.getBucketForCount=function(a){return this.countToIndex[a]};
Range.prototype.getBucketForValue=function(a){for(var b=-1,c=this.valueThresholds.length-1,d=0;d<c;d++)if(a<=this.valueThresholds[d]){b=d;break}-1===b&&(b=c);return b};
Range.prototype.mapCount=function(a){for(var b=[],c=a.length,d=0;d<this.valueThresholds.length;d++)b[d]={value:0,percent:0};var e=this,f;_.each(a,function(a){f=e.getBucketForValue(a.value);b[f].value++});for(d=0;d<this.valueThresholds.length;d++)a=new String(b[d].value),this.countToIndex[a]=d,b[d].percent=(b[d].value/c).toFixed(4);return b};Range.prototype._checkArg=function(a,b,c){if(b&&b.length!==a)throw Error("Number of valueThresholds ("+a+") and "+c+" ("+b.length+") need to match.");return b};function AxisGradient(a,b,c){this.chart=a;this.axisId=b;this.range=c;this.isDomainAscending=a.isDomainAscending(b);this.TAG_NAME="path";this.CLS_NAME=this.axisId+"-axis";this.SELECTOR=this.TAG_NAME+"."+this.CLS_NAME}AxisGradient.prototype.draw=function(){switch(this.axisId){case "x":this.drawXAxisGradient();break;case "y":this.drawYAxisGradient();break;default:throw Error("Unexpected axisId ["+this.axisId+"].");}this.hideDefaultAxis()};
AxisGradient.prototype.show=function(){this.checkGradientPaths().transition().duration(constants.TRANSITION_DURATION).attr("opacity",1)};AxisGradient.prototype.hide=function(){this.checkGradientPaths().attr("opacity",0)};AxisGradient.prototype.drawXAxisGradient=function(){var a=this,b=d3.svg.line().x(function(b){return a.chart._xScale(b)}).y(this.chart.getYViewport()).interpolate("linear"),c=this.chart._xScale.invert(this.isDomainAscending?this.chart.getXViewport():0);this.drawAxisGradient(b,c)};
AxisGradient.prototype.drawYAxisGradient=function(){var a=this,b=d3.svg.line().x(0).y(function(b){return a.chart._yScale(b)}).interpolate("linear"),c=this.chart._yScale.invert(this.isDomainAscending?0:this.chart.getYViewport());this.drawAxisGradient(b,c)};
AxisGradient.prototype.drawAxisGradient=function(a,b){for(var c=[],d=this.range.valueThresholds,e=d.length,f=0;f<e;f++)c.push([d[f],f===e-1?b:d[f+1]]);var g=this;this.getGradientPaths().data(d).enter().append(this.TAG_NAME).attr("class",function(a,b){return g.CLS_NAME+" "+g.getGradientClsName(a,g.range)}).attr("opacity",0).attr("d",function(b,d){return a(c[d])});this.chart.drawImmediately()&&this.show()};AxisGradient.prototype.getGradientPaths=function(){return this.chart.svgElem.selectAll(this.SELECTOR)};
AxisGradient.prototype.checkGradientPaths=function(){var a=this.getGradientPaths();if(0===a[0].length)throw Error("No paths for selector ["+this.SELECTOR+"].");return a};AxisGradient.prototype.getGradientClsName=function(a){for(var b=0;b<this.range.valueThresholds.length;b++)if(a<=this.range.valueThresholds[b])return this.range.cssClassNames[b];return _.last(this.range.cssClassNames)};
AxisGradient.prototype.hideDefaultAxis=function(){d3.select("#"+this.chart._idPrefix+this.axisId+"-axis path").style("stroke-width","0")};function Legend(a,b,c){this.chart=a;this.labelArr=b;this.highlightIndex=helpers.isEmpty(c)?-1:c;this.bulletWidthAndHeight=18;this.legendItemHeight=20}
Legend.prototype.draw=function(){var a=this,b=this.chart._idPrefix+"legend",b=this.chart.svgElem.selectAll("."+b).data(this.labelArr).enter().append("g").attr("class",b).attr("transform",function(b,d){return"translate(0,"+d*a.legendItemHeight+")"});b.append("rect").attr("class",function(a,b){return"legend-"+(b+1)}).attr("x",this.chart._width-this.bulletWidthAndHeight).attr("width",this.bulletWidthAndHeight).attr("height",this.bulletWidthAndHeight).attr("stroke","#000").attr("stroke-width",2).attr("fill-opacity",
function(b,d){return d===a.highlightIndex?1:0.5}).attr("stroke-opacity",function(b,d){return d===a.highlightIndex?1:0});b.append("text").attr("x",this.chart._width-24).attr("y",this.bulletWidthAndHeight/2).attr("dy",".35em").style("text-anchor","end").text(function(b,d){return a.labelArr[d]})};function Brush(a,b){this.BRUSH_SIZE=20;this.chart=a;this.axisId=b;switch(this.axisId){case "x":this.propertyName="label";this.otherPropertyName="value";break;case "y":this.propertyName="value";this.otherPropertyName="label";break;default:throw Error("Unexpected axisId ["+b+"].");}this.brushPosition={position:"x"===this.axisId?constants.ORIENTATION.right:constants.ORIENTATION.top,percentage:0.33};this.range=[-1,-1];a.addBrush(this)}
Brush.prototype.draw=function(a){helpers.isEmpty(a)&&(a=!0);this.d3Brush=d3.svg.brush();var b=0;switch(this.axisId){case "x":b=this.chart.getYViewport()-this.BRUSH_SIZE;this.d3Brush.x(this.chart._xScale);break;case "y":this.d3Brush.y(this.chart._yScale)}var c=this._calculateStartRange(this.axisId);this.d3Brush.extent(c);this.brushElem=this.chart.svgElem.append("g").attr("class","brush").attr("transform",function(a){return"translate(0,"+b+")"}).call(this.d3Brush);this.brushHandles=new BrushHandles(this.brushElem,
this.axisId,this.BRUSH_SIZE);this.brushHandles.draw(a);this.hide();a&&this.show();this.d3Brush.on("brushstart",_.bind(this._start,this)).on("brush",_.bind(this._move,this)).on("brushend",_.bind(this._end,this))};
Brush.prototype.show=function(){this.chart.svgElem.selectAll("circle."+constants.CIRCLE_CLS_NAME).data(this.chart._data);this.brushElem.selectAll("rect").transition().duration(constants.TRANSITION_DURATION).attr("x"===this.axisId?"height":"width",this.BRUSH_SIZE).attr("opacity",1);this.brushHandles.show();this._initSelection()};Brush.prototype.hide=function(){this.brushElem.selectAll("rect").attr("opacity",0);this.brushHandles.hide()};
Brush.prototype._initSelection=function(){this._start();this._move();this._end()};Brush.prototype._start=function(){this.chart.svgElem.classed("selecting",!0)};Brush.prototype._move=function(){this.chart.brushManager().select(this)};Brush.prototype._end=function(){this.chart.svgElem.classed("selecting",!0);this.chart.svgElem.selectAll("g.resize").style("display","block")};
Brush.prototype._checkMinMax=function(a){if(!a||2!==a.length)throw Error("Expected array with two elements, but found "+(a?"an array with ["+a.length+"] elements":"["+a+"]")+".");if(a[0]>a[1]){var b=a[0];a[0]=a[1];a[1]=b}return a};
Brush.prototype._calculateStartRange=function(a){if(0<=this.range[0]&&0<=this.range[1]){var b=this.chart.getDomainArr(a);return this._checkStartRange(a,b,this.range)}if(0<=this.range[0]||0<=this.range[1])throw Error("Expected both minimum and maximum values for range, but found ["+this.range[0]+"-"+this.range[1]+"].");this._checkBrushPosition(this.axisId,this.brushPosition);return this._getPercentageStartRange(a)};
Brush.prototype._getPercentageStartRange=function(a){var b=(a="x"===a)?this.chart.getXViewport():this.chart.getYViewport();return this._calculatePercentageStartRange(b,this.brushPosition.position,this.brushPosition.percentage,(a?this.chart._xScale:this.chart._yScale).invert)};
Brush.prototype._shouldSetBrushInMinimumPosition=function(a,b){var c=constants.ORIENTATION;switch(a){case c.left:case c.top:return b;case c.right:case c.bottom:return!b;default:throw Error("Unexpected brush position ["+this.brushPosition+"].");}};Brush.prototype._calculatePercentageStartRange=function(a,b,c,d){var e=d(0);a=d(a);b=this._shouldSetBrushInMinimumPosition(b,e<a);a=this._checkMinMax([e,a]);e=a[0];a=a[1];b?a*=c:e=a*(1-c);return[e,a]};
Brush.prototype._checkBrushPosition=function(a,b){var c=b.position,d=constants.ORIENTATION,d="x"===a?[d.left,d.right]:[d.top,d.bottom];if(c!==d[0]&&c!==d[1])throw Error("A brush along the "+a+" axis can only be positioned left or right, but received ["+c+"].");c=b.percentage;if(0>=c||1<=c)throw Error("A brush percentage must be between 0 and 1, exclusive, but received ["+c+"].");return b};
Brush.prototype._checkStartRange=function(a,b,c){b=b.slice(0);if(helpers.isEmpty(b)||helpers.isEmpty(b[0])||helpers.isEmpty(b[1]))throw Error("No domain set for chart.");this._checkMinMax(b);if(c[0]<b[0])throw Error("Brush range minimum ["+c[0]+"] is less than smallest value ["+b[0]+"] for axis ["+a+"].");if(c[1]>b[1])throw Error("Brush range maximum ["+c[1]+"] is greater than largest value ["+b[1]+"] for axis ["+a+"].");if(c[0]>=c[1])throw Error("Invalid brush range ["+c[0]+"-"+c[1]+"].");return c};function BrushHandles(a,b,c){this.brushElem=a;this.halfBrushSize=c/2;a=[0,180];c=[90,270];var d=[180,360],e=[270,450];this.brushHandleYPos=this.brushHandleXPos=0;switch(b){case "x":this.faces=[a,d];this.brushHandleYPos=this.halfBrushSize;break;case "y":this.faces=[e,c];this.brushHandleXPos=this.halfBrushSize;break;default:throw Error("Unexpected axisId ["+b+"].");}}
BrushHandles.prototype.draw=function(a){helpers.isEmpty(a)&&(a=!0);var b=this,c=d3.svg.arc().outerRadius(this.halfBrushSize).startAngle(function(a,c){return b.degreesToRadians(b.faces[c][0])}).endAngle(function(a,c){return b.degreesToRadians(b.faces[c][1])});this.brushElem.selectAll(".resize").append("path").attr("opacity",0).attr("transform","translate("+this.brushHandleXPos+","+this.brushHandleYPos+")").attr("d",c);a&&this.show()};BrushHandles.prototype.show=function(){this._setOpacity(1)};
BrushHandles.prototype.hide=function(){this._setOpacity(0)};BrushHandles.prototype.degreesToRadians=function(a){return a*(Math.PI/180)};BrushHandles.prototype._setOpacity=function(a){this.brushElem.selectAll(".resize path").transition().duration(constants.TRANSITION_DURATION).attr("opacity",a)};var pairedChartHelpers={INNER_PADDING:0.3,OUTER_PADDING:0.1,transformDataForChart:function(a,b,c,d){var e=[],f=b.mapCount(a);a=b.mapCount(a.filter(function(a){return a[c]===d}));for(b=0;b<f.length;b++)e.push({value:f[b].percent,value0:a[b].percent});return e}};var stackedChartHelpers={init:function(a){if(!a._stack)throw Error("stack parameter required for "+a.__proto__.constructor.name);var b=_.bind(a._stack.stackFn,a)(),b=d3.layout.stack().out(function(a,b,e){a.value0=b;a.value=e})(b);a.data(b)},getFirstLayerArr:function(a){a=a._data[0];if(!_.isArray(a))throw Error("Expected array, but found ["+typeof a+"]: "+a);return a},subsetStackFn:function(a){return["_subset","_data"].map(function(b){for(var c=[],d=0;d<a._data.length;d++)c.push({label:a._tickLabelFn(a._data[d]),
y:a[b][d].value});return c})}};function LineLabelledChart(a,b){this.LABELS_WIDTH=150;this.ALPHA=1.5;this.SPACING=12;this.range=b;this.config(a)}_.extend(LineLabelledChart.prototype,Chart.prototype);
LineLabelledChart.prototype.chart=function(a){this.xScale().domain([_.first(this.range),_.last(this.range)]);this.xScale().range([0,this.getXViewport()]);a=_(this.data()).chain().pluck("values").flatten().value();this.yDomain(helpers.minToMax);this.yScale().domain(this._yDomain(a));this.yScale().range([this.getYViewport(),0]);var b=this;this.lines=this.data().map(function(a){var d=_.last(a.values).value,d=b._yScale(d);return{label:a.label,y:d}});return this};
LineLabelledChart.prototype.draw=function(){var a=d3.select("svg"),b=+a.attr("width")+this.LABELS_WIDTH;a.attr("width",b);this.addSeries();this.labelXPos=this._xScale(_.last(this.range));d3.timer(_.bind(this.positionLabels,this));return this};
LineLabelledChart.prototype.addSeries=function(){var a=this,b=d3.svg.line().interpolate("basis").defined(function(b){return a.hasValue(b)}).x(function(b,c){return a._xScale(a.range[c])}).y(function(b){return a._yScale(b.value)}),c=this.svgElem.selectAll(".series").data(this.data()).enter().append("g").attr("class","series");c.append("path").attr("d",function(a){return b(a.values)}).style("stroke",function(b,c){return a.getHclColor(c)}).attr("class","active").attr("d",function(a){return b(a.values)});
c.append("text").attr("class","label active").data(this.lines).style("fill",function(b,c){return a.getHclColor(c)}).text(function(a){return a.label});c.selectAll(".active").on("mouseover",_.bind(function(b){a.onMouseOver(b)},this)).on("mouseout",_.bind(this.onMouseOut,this))};
LineLabelledChart.prototype.positionLabels=function(){var a=!1,b=this;b.lines.forEach(function(c,d){b.lines.slice(d+1).forEach(function(d){var f=c.y-d.y;Math.abs(f)<b.SPACING&&(a=!0,f=0<f?1:-1,c.y+=f*b.ALPHA,d.y-=f*b.ALPHA)})});d3.selectAll(".label").attr("transform",function(a){return"translate("+b.labelXPos+","+a.y+")"});return!a};
LineLabelledChart.prototype.hasValue=function(a){if(null===a||null===a.value)return!1;var b=typeof a.value;if("number"===b)return!0;throw Error("Found unexpected type ["+b+"] for:",a.value);};LineLabelledChart.prototype.getColor=function(a,b,c){return a.label==b.label?this.getHclColor(c):constants.DESELECTED_COLOR};LineLabelledChart.prototype.getHclColor=function(a){return d3.hcl(55*a,55,38).toString()};
LineLabelledChart.prototype.onMouseOver=function(a){var b=this;d3.selectAll(".series path").classed("hover",function(b){return b.label==a.label}).style("stroke",function(c,d){return b.getColor(a,c,d)});d3.selectAll(".series text").classed("hover",function(b){return b.label==a.label}).style("fill",function(c,d){return b.getColor(a,c,d)})};
LineLabelledChart.prototype.onMouseOut=function(){var a=this;d3.selectAll(".series path").classed("hover",!1).style("stroke",function(b,c){return a.getHclColor(c)});d3.selectAll(".series text").classed("hover",!1).style("fill",function(b,c){return a.getHclColor(c)})};function StackedColumnChart(a){this.config(a)}_.extend(StackedColumnChart.prototype,Chart.prototype);
StackedColumnChart.prototype.chart=function(a){stackedChartHelpers.init(this);a=stackedChartHelpers.getFirstLayerArr(this);var b=this;this.xDomain(a.map(function(a){return b._tickLabelFn(a)}));this._xScale.domain(this._xDomain).rangeRoundBands([0,this.getXViewport()]);this.yDomain(helpers.zeroToLayeredMax);this.yDomain(this._yDomain(this._data));this._yScale.domain(this._yDomain).range([this.getYViewport(),0])};
StackedColumnChart.prototype.draw=function(){var a=this;this.svgElem.selectAll("g.band").data(this.data()).enter().append("g").attr("class",function(a,c){return"band band-"+(c+1)}).selectAll("rect").data(Object).enter().append("rect").attr("x",function(b){return a._xScale(a._tickLabelFn(b))}).attr("width",a._xScale.rangeBand()).attr("y",function(b){return a._yScale(b.value0+b.value)}).attr("y",a.getYViewport()).attr("height",0).transition().duration(constants.TRANSITION_DURATION).attr("y",function(b){return a._yScale(b.value0+
b.value)}).attr("height",function(b){b=helpers.scaleValue(a,"y",b.value,a._yScale);return 0===b?0:a.getYViewport()-b})};function BrushManager(){this.brushes={}}BrushManager.prototype.register=function(a){var b=a.axisId;if(this.brushes[b])throw Error("A brush for axisId ["+b+"] is already registered.");if(2<=this.brushes.length)throw Error("There are already two brushes registered.");this.brushes[b]=a};BrushManager.prototype.toggleBrushes=function(a){_.each(this.brushes,function(b,c){a?b.show():b.hide()})};
BrushManager.prototype.select=function(a){var b=this.brushes["x"===a.axisId?"y":"x"],c=this,d=[];a.chart.svgElem.selectAll("circle."+constants.CIRCLE_CLS_NAME).classed("selected",function(e){if(helpers.isEmpty(e))return!1;var f=c._shouldSelect(e,a);f&&b&&(f=c._shouldSelect(e,b));f&&d.push(e);return f});$.event.trigger({type:"select",selectedItems:d})};BrushManager.prototype._shouldSelect=function(a,b){var c=a[b.propertyName],d=b.d3Brush.extent(),e=d[1];return c>=d[0]&&c<=e};//# sourceMappingURL=pfchart.map
